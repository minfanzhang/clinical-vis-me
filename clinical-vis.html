<!--
@license
Copyright 2018 Google Inc.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
    http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

http://localhost:8081/components/clinical-vis/demo/index.html
http://localhost:8081/components/clinical-vis/demo/table-index.html
-->
<link rel="import" href="../polymer/polymer.html">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,500,500i,700,700i" rel="stylesheet">
<dom-module id="clinical-vis">
  <template>
    <style>
      :host{
        font-family: 'Roboto', sans-serif;
        font-size: 13sp;
        line-height: 1.2em;
      }
      body {
        margin: 0px;
        background: #fcfcfc;
      }
      .basic-data {
        min-width: 220px;
        width: 220px;
        float: left;
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        margin-right: 24px;
        border-radius: 3px;
        }
      .basic-data-heading {
        background: #E3EEEF;
        font-weight: 400;
        color: #26272A;
        padding: 6px;
        font-size: 10pt;
        border-bottom: solid 3px #c0dadc;
      }
      .basic-data-pair {
        display: block;
        margin: 4px;
        padding: 4px;
      }
      .basic-data-key {
        font-size: 10pt;
        line-height: 1.2em;
        font-weight: 300;
        padding-left: 4px;
        color: #356266;
      }
      .basic-data-value {
        font-size: 11pt;
        line-height: 1.4em;
        padding: 4px;
        color: #232321;
        font-weight: 400;
        hyphens: auto;
      }
      .cat-holder {
        font-size: 16sp;
        font-weight: 300;
        color: #0063A3;
      }
      .key-and-chart-holder {
        display: flex;
        font-size: 14sp;
        padding: 8px 0px;
        border-bottom: solid 2px #f2f3f5;
      }
      .bar-key-holder {
        padding: 20px;
        width: 120px;
        min-width: 120px;
        text-align: right;
        font-size: 16sp;
        font-weight: 400;
        color: #db5825;
      }
      .vitals-top-holder {
        display: flex;
      }
      .cat-holder-inner {
        padding: 20px;
        width: 120px;
        min-width: 120px;
        text-align: right;
        font-size: 16sp;
        font-weight: 400;
        color: #db5825;
      }
      .key-holder {
        width: 120px;
        min-width: 120px;
        font-weight: 400;
        color: #561f06;
        font-size: 10pt;
        text-align: right;
        padding: 10px;
      }
      .chart-holder {
        padding: 20px;
        width: 500px;
        flex-grow: 1;
        padding-bottom: 5px 0px;
      }
      .chart-holder-inner {
        width: 100%;
      }
      .xaxis-holder {
        margin-left: 190px;
        font-size: 8pt;
        color: #525251;
        border-bottom: solid 3px #D3DADB;
      }
      .vitals-axis-holder {
        margin-left: 30px;
        padding-top: 18px;
        font-size: 8pt;
        color: #525251;
        border-bottom: solid 3px #D3DADB;
        overflow: visible;
      }
      .heading-label {
        font-weight: 400;
        color: #F0F2F0;
        padding: 4px;
        font-size: 11pt;
      }
      .note-card {
        border: solid 1px #D3DADB;
        background: #F7FFF7;
        border-radius: 3px;
        margin: 0px 24px 24px 0px;
        min-width: 600px;
        width: 600px;
        box-shadow: 0 1px 3px rgba(4,28,2,0.12), 0 1px 2px rgba(0,2,0,0.24);
      }
      .note-heading {
        font-weight: 500;
        font-size: 16sp;
        background: #448e3d;
        color: #F0F2F0;
        padding: 6px;
      }
      .note-text {
        min-height: 300px;
        height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
        resize: vertical;
        white-space: pre-line;
        font-size: 11pt;
        line-height: 1.4em;
        padding: 12px;
        color: rgba(0,0,0,0.84);
        border-top: solid 3px #1f541a;
      }
      .lab-card {
        border: solid 1px #D3DADB;
        background: #f7fdff;
        border-radius: 3px;
        margin: 0px 24px 24px 0px;
        min-width: 600px;
        width: 600px;
        box-shadow: 0 1px 3px rgba(2,22,25,0.12), 0 1px 2px rgba(0,6,7,0.24);
      }
      .lab-heading {
        font-weight: 500;
        font-size: 16sp;
        color: #F0F2F0;
        background: #1ca4bc;
        padding: 6px;
      }
      .selected-labs {
        padding-bottom: 24px;
        border-top: solid 3px #296671;
        min-height: 400px;
        height: 400px;
        overflow-y: scroll;
        resize: vertical;
      }
      .lab-key-and-value {
        display: flex;
        padding: 2px;
        font-size: 14px;
        border-bottom: solid 0.5px rgb(218, 229, 232);
        margin-bottom: 1px;
        height: 40px;
        line-height: 40px;
      }
      .lab-key {
        font-weight: 500;
        text-align: right;
        padding-right: 18px;
        min-width: 200px;
        width: 200px;
        color: #023a44;
        border-right: solid 1px rgba(218, 229, 232, 0.75);
      }
      .lab-value {
        min-width: 40px;
        width: 40px;
        text-align: right;
        color: #03697b;
      }
      .lab-units {
        min-width: 40px;
        width: 40px;
        font-size: 9pt;
        color: #75a2aa;
        padding-left: 3px;
        line-height: 44px;
      }
      .chart-units {
        font-size: 12px;
        color: #8C615A;
        padding-left: 3px;
        font-weight: 400;
        line-height: 1em;
      }
      .lab-sparkline {
        width: 120px;
        min-width:120px;
        margin: 6px 36px 6px auto;
      }
      .charts-and-labs {
        overflow: hidden;
      }
      .chart-card {
        border: 1px solid #D3DADB;
        border-radius: 3px;
        background: rgba(255, 251, 249,0.12);
        box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        width: 95%;
        min-width: 35%;
        display: inline-block;
        vertical-align: top;
        position: relative;
      }
      .chart-card-heading {
        font-weight: 400;
        font-size: 16sp;
        color: #561f06;
        background: #ff0000;
        padding: 6px;
      }
      #chartstop {
        padding: 20px;
        overflow: auto;
        border-top: solid 3px #dc987a;
      }
      #textarea {
        font-family: 'Roboto', sans-serif;
        display: inline-block;
        vertical-align: top;
        position: relative;
      }
      .c3-ygrid-line {
        stroke: #D3DADB;
      }
      .c3-axis-y{
        font-family: 'Roboto', sans-serif;
        color: #26272A;
      }
      .c3 line {
        stroke: #D3DADB;
      }
      .c3 .domain {
        stroke: #D3DADB;
      }
      .limit-line line {
        stroke: rgba(204, 217, 172, 0.50);
        stroke-width: 3;
      }
      .lab-limit-line line {
        stroke: rgba(176, 193, 133, 0.50);
        stroke-width: 1.5;
      }
      .chart-holder-inner-bar {
        margin-left: 30px;
      }
      .xaxis-holder line {
        stroke: #525251;
      }
      .xaxis-holder .domain {
        display: none;
      }
      .vitals-axis-holder line {
        stroke: #525251;
      }
      .vitals-axis-holder .domain {
        display: none;
      }
      .c3-text {
        font-family: 'Roboto', sans-serif;
        font-weight: 400;
      }
    </style>
      <div class="chart-card">
        <div class="chart-card-heading">Waveform Visualization & Labelling</div>
        <div id="chartstop"></div>
      </div>
    </div>
  </template>
  <script>
    const unitData = {
      'Albumin': {'units': 'g/dL', 'low': 3.5, 'high': 6},
      'Anion Gap': {'units': 'mEq/L'},
      'Bicarbonate': {'units': 'mEq/L', 'low': 22, 'high': 32},
      'Bilirubin': {'units': 'mg/dL', 'low': 0.1, 'high': 1.2},
      'Blood urea nitrogen': {'units': 'mEq/L', 'low': 6, 'high': 20},
      'Calcium': {'units': 'mg/dL', 'low': 8.4, 'high': 10.3},
      'Chloride': {'units': 'mEq/L', 'low': 96, 'high': 108},
      'Cholesterol': {'units': 'mg/dL', 'low': 40, 'high': 240},
      'Creatinine': {'units': 'mEq/L', 'low': 0.4, 'high': 1.1},
      'Diastolic blood pressure': {'units': 'mmHg', 'low': 60, 'high': 90},
      'Fraction inspired oxygen': {'units': '%'},
      'Glucose': {'units': 'mg/dL', 'low': 70, 'high': 105},
      'Heart Rate': {'units': 'bpm', 'low': 50, 'high': 100},
      'Hematocrit': {'units': '%', 'low': 37, 'high': 52},
      'Hemoglobin': {'units': 'g/dL', 'low': 11.2, 'high': 15.7},
      'Lactate': {'units': 'mmol/dL', 'low': .5, 'high': 2},
      'Lymphocytes': {'units': 'm/uL', 'low': 1, 'high': 3},
      'Magnesium': {'units': 'mg/dL', 'low': 1.6, 'high': 2.6},
      'Mean blood pressure': {'units': 'mmHg'},
      'Monocytes': {'units': 'M/uL', 'low': .2, 'high': 1},
      'Neutrophilis': {'units': 'M/uL', 'low': 2, 'high': 7},
      'Oxygen saturation': {'units': '%', 'low': 94, 'high': 100},
      'Partial pressure of CO2': {'units': 'mmHg', 'low': 38, 'high': 42},
      'Partial pressure of O2': {'units': 'mmHg', 'low': 75, 'high': 100},
      'pH': {'low': 7.35, 'high': 7.45},
      'Phosphate': {'units': 'mg/dL', 'low': 2.7, 'high': 4.5},
      'Platelets': {'units': 'K/uL', 'low': 150, 'high': 400},
      'Potassium': {'units': 'mEq/L', 'low': 3.3, 'high': 5.1},
      'Prothrombin time': {'units': 'secL', 'low': 11, 'high': 14},
      'Partial thromboplastin time': {'units': 'sec', 'low': 25, 'high': 35},
      'Red blood cell count': {'units': 'M/uL', 'low': 42, 'high': 6.1},
      'Respiratory rate': {'units': 'bpm', 'low': 12, 'high': 25},
      'Sodium': {'units': 'mEq/L', 'low': 133, 'high': 145},
      'Systolic blood pressure': {'units': 'mmHg', 'low': 95, 'high': 140},
      'Temperature': {'units': 'C', 'low': 36.6, 'high': 37},
      'Troponin-I': {'units': 'ng/mL'},
      'Troponin-T': {'units': 'ng/mL', 'low': 0, 'high': 0.01},
      'Urine output': {},
      'Weight': {'units': 'kg', 'low': 40, 'high': 240},
      'White blood cell count': {'units': 'K/uL', 'low': 5, 'high': 10},
    };
    Polymer({
      is: "clinical-vis",
      properties: {
        json: {tye: String, observer: 'jsonChanged'},
        noteTime: String,
        noteText: String,
        age: Number,
        selectedNoteIndex: Number,
        notesChart: Object,
      },
      getFakeName: function(gender) {
        return gender == 'M' ? 'John Doe' : 'Jane Doe';
      },
      getIcuName: function(icu) {
        if (icu == 'TSICU') {
          return 'Trauma ICU';
        }
        if (icu == 'CSRU') {
          return 'Cardiac Surgical Recovery Unit';
        }
        return icu;
      },
      getItemText: function(event) {
        const isNum = !isNaN(event.value) && event.value != '';
        if (isNum) {
          let num = parseFloat(event.value)
          return +num.toFixed(3);
        }
        return event.value;
      },
      getKeyUnits: function(key) {
        return unitData[key] && unitData[key].units ? unitData[key].units : null;
      },
      getKeyRange: function(key) {
        return unitData[key] && unitData[key].low ? [unitData[key].low, unitData[key].high] : null;
      },
      jsonChanged: function(json) {
        this.$.chartstop.innerHTML = '';
        const dob = new Date(json.dob)
        const firstEntryDate = new Date(+json.events[0].timestamp * 1000);
        const diff = firstEntryDate.getTime() - dob.getTime();
        this.age = Math.floor(diff / (1000*60*60*24*365.25));
        json.events.forEach((item) => {
          if (!item['category']) {
            item['category'] = 'Other';
          }
        });
        timestamps = json.events.map(event => event['timestamp']).sort();
        timestamps = timestamps.filter((item, pos) => pos == 0 || item != timestamps[pos - 1]);
        categories = json.events.map(event => event['category']).sort();
        categories = categories.filter((item, pos) => pos == 0 || item != categories[pos - 1]);
        eventsByCat = {}
        categories.forEach((cat) => eventsByCat[cat] = {});
        for (var cat in eventsByCat) {
          if (cat == 'Other') {
            continue;
          }
          keys = json.events.filter((item) => item['category'] == cat).map((item) => item['key']).sort();
          keys = keys.filter((item, pos) => pos == 0 || item != keys[pos - 1]);
          for (key of keys) {
            const timeToEvents = {}
            events = json.events.filter((item) => item['category'] == cat).filter((item) => item['key'] == key);
            for (event of events) {
              timeToEvents[event['timestamp']] = event;
            }
            eventsByCat[cat][key] = timeToEvents;
          }
        }
        //this.generateCharts(eventsByCat, json.notes.sort((a, b) => a.timestamp - b.timestamp));
        this.generate_single_waveform(eventsByCat, json.notes.sort((a, b) => a.timestamp - b.timestamp));
      },

      generate_single_waveform(eventsByCat, notes) {
        minX = Number.MAX_VALUE;
        maxX = 0;
        
        // X limit of the X-axis(hard coded for now)
        minX = 6727651200;
        maxX = 6727730400;

        // Pad one extra hour to ensure enough space for edge data points and their labels.
        minX -= 60 * 60;
        maxX += 60 * 60;
        this.minX = minX;
        this.maxX = maxX;
        const labKeys = [];
        this.labsList = labKeys;
        const holder = d3.select(this.$.chartstop)
        let currentCat = '';
        let currentCatSelection = null;
        const xAxisWidth = holder.node().getBoundingClientRect().width - 190 - 40;
        const xAxisHeight = 20;
        const xAxisVis = holder.append("svg:svg")
                               .attr('class', 'xaxis-holder')
                               .attr("width", xAxisWidth)
                               .attr("height", xAxisHeight)
                               .attr('overflow', 'visible');
        const offsetToUTC = new Date(minX * 1000).getTimezoneOffset() * 60;
        const xScale = d3.time.scale()
                          .domain([new Date((minX + offsetToUTC) * 1000), new Date((maxX + offsetToUTC) * 1000)])
                          .rangeRound([0, xAxisWidth]);
        const xAxis = d3.svg.axis()
                            .orient('top')
                            .scale(xScale);



        dummay_currentCat = "dummy_Vitals";
        dummay_currentCatSelection = holder.append('div').classed('cat-holder', true);
        const dummy_vitalsHeadingHolder = dummay_currentCatSelection.append('div');
        dummy_vitalsHeadingHolder.classed('vitals-top-holder', true);
        dummy_vitalsHeadingHolder.append('div').classed('cat-holder-inner', true).html("dummy_Vitals");
        const dummy_xAxisVis = dummy_vitalsHeadingHolder.append("svg:svg")
                               .attr('class', 'vitals-axis-holder')
                               .attr("width", xAxisWidth)
                               .attr("height", xAxisHeight)
                               .attr('overflow', 'auto');
        dummy_xAxisVis.append("g")
                .attr("class", "xaxis")
                .attr("transform", "translate(0," + xAxisHeight + ")")
                .call(xAxis.tickFormat(d3.timeFormat("%I %p")).tickSize(-10));

        const dummy_keyAndChartDiv = dummay_currentCatSelection.append('div').classed(
            'key-and-chart-holder', true);
        const dummy_chartUnits = "bpm";
        const dummy_chartRange = [36.6, 37];
        const dummy_chartTitleDiv = dummy_keyAndChartDiv.append('div');
        dummy_chartTitleDiv.classed('key-holder', true).html("Heart Rate");
        dummy_chartTitleDiv.append('span').classed('chart-units', true).classed('lab-units', true).html('(' + dummy_chartUnits + ')');
        const dummy_chartDiv = dummy_keyAndChartDiv.append('div')
                                        .classed('chart-holder', true)
                                        .append('div')
                                        .classed('chart-holder-inner', true);
        const dummy_x = ["time", 6727679100000, 6727680900000, 6727692600000, 6727662000000];
        const dummy_y = ["Heart Rate", 37.46, 37.34, 37.57, 37.57];
        const dummy_gridData = {y: {show: true}};
        dummy_gridData.y['lines'] = [
          {value: +dummy_chartRange[0], class: 'limit-line'},
          {value: +dummy_chartRange[1], class: 'limit-line'},
        ];

        const dummy_colorSelector = (color, d) => '#db5825';
        const dummy_chart = c3.generate({
          bindto: dummy_chartDiv,
          data: {
            x: 'time',
            xFormat: '%Y-%m-%dT%H:%M:%S.%LZ',
            columns: [dummy_x, dummy_y],
            labels: {
              format: (v, id, i, j) => +(+v).toFixed(2) + '',
            },
            color: dummy_colorSelector,
          },
          size: {
            height: 60,
          },
          axis: {
            x: {show: false, type: 'timeseries', localtime: false, min: minX * 1000, max: maxX * 1000},
            y: {show: true, tick: { count: 3, format: d3.format('.1f')}, padding: {top: 20, bottom: 6} }
          },
          legend: {
            show: false
          },
          grid: dummy_gridData,
        });

        const dummay_barDiv = dummay_currentCatSelection.append('div').classed('chart-holder', true)
            .append('div').classed('chart-holder-inner-bar', true).classed('chart-holder-inner', true);
        
        const selected_stamps_lst = [[], [], [], [], [], []];
        const dummy_buttomClickListener = (e) => {
          
          const dummy_x_added = ["time", 6727679100000, 6727680900000, 6727692600000, 6727662000000];
          let dummy_y_added;
          if (e.x === 0) {
            dummy_y_added = ["Heart Rate 1", 37.46, 37.68, 37.57, 37.57];
          } 
          else if(e.x === 1) {
            dummy_y_added = ["Heart Rate 2", 37.32, 37.68, 37.51, 37.41];
          }
          else if(e.x === 2) {
            dummy_y_added = ["Heart Rate 3", 37.66, 37.54, 37.43, 37.32];
          }          
          else if(e.x === 3) {
            dummy_y_added = ["Heart Rate 4", 37.45, 37.44, 37.57, 37.39];
          }
          else if(e.x === 4) {
            dummy_y_added = ["Heart Rate 5", 37.35, 37.45, 37.58, 37.62];
          }
          else {
            dummy_y_added = ["Heart Rate 6", 37.49, 37.32, 37.68, 37.51];
          }

          const dummy_colorSelector_range = function(color, d) {
            if (selected_stamps_lst[e.x].includes(d.index)) {
              return '#db5825';
            }
            else {
              return '#01e925';
            }
            
          }

          const dummy_chart_added = c3.generate({
            bindto: dummy_chartDiv,
            data: {
              x: 'time',
              xFormat: '%Y-%m-%dT%H:%M:%S.%LZ',
              columns: [dummy_x_added, dummy_y_added],
              labels: {
                format: (v, id, i, j) => +(+v).toFixed(2) + '',
              },
              color: dummy_colorSelector_range,
              onclick: dummy_timeStampClickListener,
            },
            size: {
              height: 60,
            },
            axis: {
              x: {show: false, type: 'timeseries', localtime: false, min: minX * 1000, max: maxX * 1000},
              y: {show: true, tick: { count: 3, format: d3.format('.1f')}, padding: {top: 20, bottom: 6} }
            },
            legend: {
              show: false
            },
            grid: dummy_gridData,
          });

        }

        const dummy_timeStampClickListener = (e) => {
          selected_stamps_lst[parseInt(e.id.split(" ")[2]) - 1].push(e.index)
          console.log("selected_stamps_lst is ", selected_stamps_lst)
        }

        const dummy_colorButtonSelector = (color, d) => '#ff7fc5';
        const dummy_chart_selectButtons = c3.generate({
          bindto: dummay_barDiv,
          data: {
            columns: [
              ['data1', 10, 10, 10, 10, 10, 10]
            ],
            types: {
              data1: 'bar',
            },
            color: dummy_colorButtonSelector,
            onclick: dummy_buttomClickListener,
          },
          size: {
            height: 200,
            width: 200
          },
          axis: {
            rotated: true,
            x: {
              show: true,
              type: 'category',
              categories: ['Waveform 1', 'Waveform 2', 'Waveform 3', 'Waveform 4', 'Waveform 5', 'Waveform 6']
            },
            y: {
              show: false
            }
          },
          legend: {
            show: false
          },
          tooltip: {
            show: false
          },
          bar: {
            width: 20
          },
        });



        const dummay_labelSelectorDiv = dummay_currentCatSelection.append('div').classed('chart-holder', true)
            .append('div').classed('chart-holder-inner-bar', true).classed('chart-holder-inner', true);


        const dummy_labelClickListener = (e) => {
          if (e.x >= 0 && e.x <= 4) {
            num_label = e.x + 1;
            dummay_labelPadDiv.html("Note " + num_label + " for this waveform.");
          } else {
            dummay_labelPadDiv.html("Not sure about this waveform.");
          }

        }

        const dummy_chart_selectLabels = c3.generate({
          bindto: dummay_labelSelectorDiv,
          data: {
            columns: [
              ['labels', 10, 10, 10, 10, 10, 10]
            ],
            types: {
              labels: 'bar',
            },
            onclick: dummy_labelClickListener,
          },
          size: {
            height: 60,
            width: 600
          },
          axis: {
            x: {
              show: true,
              type: 'category',
              categories: ['note 1', 'note 2', 'note 3', 'note 4', 'note 5', 'not sure']
            },
            y: {
              show: false
            }
          },
          legend: {
            show: false
          },
          tooltip: {
            show: false
          },
          bar: {
            width: 50
          },
        });



        const dummay_labelPadDiv = dummay_currentCatSelection.append('div').classed('chart-holder', true)
            .append('div').classed('chart-holder-inner-bar', true).classed('chart-holder-inner', true);

        dummay_labelPadDiv.html("This is a note!");


      }




    });
  </script>
</dom-module>